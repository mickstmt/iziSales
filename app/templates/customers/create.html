{% extends "layouts/base.html" %}

{% block title %}Nuevo Cliente{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('customers.index') }}">Clientes</a></li>
            <li class="breadcrumb-item active">Nuevo Cliente</li>
        </ol>
    </nav>
    <h2><i class="bi bi-person-plus"></i> Nuevo Cliente</h2>
</div>

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-body">
                <form method="POST" id="customerForm">
                    <!-- Tipo y Número de Documento -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="document_type" class="form-label">Tipo de Documento *</label>
                            <select class="form-select" id="document_type" name="document_type" required>
                                <option value="">Seleccionar...</option>
                                <option value="DNI">DNI</option>
                                <option value="RUC">RUC</option>
                                <option value="CE">Carnet de Extranjería</option>
                                <option value="PASAPORTE">Pasaporte</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label for="document_number" class="form-label">
                                Número de Documento *
                                <span class="badge bg-info" id="apiBadge" style="display: none;">
                                    <i class="bi bi-cloud-check"></i> <span id="apiBadgeText">RENIEC</span>
                                </span>
                            </label>
                            <div class="input-group">
                                <input
                                    type="text"
                                    class="form-control"
                                    id="document_number"
                                    name="document_number"
                                    maxlength="11"
                                    required
                                    placeholder="Ej: 12345678 o 20123456789"
                                >
                                <button
                                    type="button"
                                    class="btn btn-outline-primary"
                                    id="btnConsultarSunat"
                                    disabled
                                    title="Consultar documento en SUNAT/RENIEC"
                                >
                                    <i class="bi bi-search"></i> Buscar Documento
                                </button>
                            </div>
                            <div class="form-text" id="documentHelp">Selecciona el tipo de documento primero</div>
                            <div id="sunatStatus" class="mt-2" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Nombre Completo -->
                    <div class="mb-3">
                        <label for="name" class="form-label">Nombre Completo / Razón Social *</label>
                        <input
                            type="text"
                            class="form-control"
                            id="name"
                            name="name"
                            maxlength="255"
                            required
                            placeholder="Ej: Juan Pérez García"
                        >
                    </div>

                    <!-- Email -->
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input
                            type="email"
                            class="form-control"
                            id="email"
                            name="email"
                            maxlength="120"
                            placeholder="ejemplo@correo.com"
                        >
                    </div>

                    <!-- Teléfono -->
                    <div class="mb-3">
                        <label for="phone" class="form-label">Teléfono</label>
                        <input
                            type="tel"
                            class="form-control"
                            id="phone"
                            name="phone"
                            maxlength="20"
                            placeholder="987654321"
                        >
                    </div>

                    <!-- Dirección -->
                    <div class="mb-3">
                        <label for="address" class="form-label">Dirección</label>
                        <textarea
                            class="form-control"
                            id="address"
                            name="address"
                            rows="2"
                            maxlength="255"
                            placeholder="Av. Principal 123, Distrito, Ciudad"
                        ></textarea>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('customers.index') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Guardar Cliente
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Elementos del DOM
const documentTypeSelect = document.getElementById('document_type');
const documentNumberInput = document.getElementById('document_number');
const documentHelp = document.getElementById('documentHelp');
const btnConsultarSunat = document.getElementById('btnConsultarSunat');
const sunatStatus = document.getElementById('sunatStatus');
const apiBadge = document.getElementById('apiBadge');
const apiBadgeText = document.getElementById('apiBadgeText');
const nameInput = document.getElementById('name');
const addressInput = document.getElementById('address');

// Validación dinámica según tipo de documento
documentTypeSelect.addEventListener('change', function() {
    const type = this.value;

    // Limpiar campos
    documentNumberInput.value = '';
    nameInput.value = '';
    addressInput.value = '';
    sunatStatus.style.display = 'none';
    apiBadge.style.display = 'none';
    btnConsultarSunat.disabled = true;

    switch(type) {
        case 'DNI':
            documentNumberInput.setAttribute('maxlength', '8');
            documentNumberInput.setAttribute('pattern', '[0-9]{8}');
            documentNumberInput.setAttribute('placeholder', '12345678');
            documentHelp.innerHTML = '<i class="bi bi-info-circle"></i> DNI debe tener 8 dígitos. Click en "Buscar" para consultar en RENIEC';
            break;
        case 'RUC':
            documentNumberInput.setAttribute('maxlength', '11');
            documentNumberInput.setAttribute('pattern', '[0-9]{11}');
            documentNumberInput.setAttribute('placeholder', '20123456789');
            documentHelp.innerHTML = '<i class="bi bi-info-circle"></i> RUC debe tener 11 dígitos. Click en "Buscar" para consultar en SUNAT';
            break;
        case 'CE':
            documentNumberInput.setAttribute('maxlength', '12');
            documentNumberInput.removeAttribute('pattern');
            documentNumberInput.setAttribute('placeholder', '001234567');
            documentHelp.textContent = 'Carnet de Extranjería';
            break;
        case 'PASAPORTE':
            documentNumberInput.setAttribute('maxlength', '20');
            documentNumberInput.removeAttribute('pattern');
            documentNumberInput.setAttribute('placeholder', 'A12345678');
            documentHelp.textContent = 'Número de Pasaporte';
            break;
        default:
            documentNumberInput.setAttribute('maxlength', '20');
            documentNumberInput.removeAttribute('pattern');
            documentNumberInput.setAttribute('placeholder', '');
            documentHelp.textContent = 'Selecciona el tipo de documento primero';
    }
});

// Solo números para DNI y RUC
documentNumberInput.addEventListener('input', function() {
    const type = documentTypeSelect.value;
    const numero = this.value;

    if (type === 'DNI' || type === 'RUC') {
        this.value = this.value.replace(/[^0-9]/g, '');
    }

    // Habilitar botón SUNAT si cumple requisitos
    if ((type === 'DNI' && numero.length === 8) || (type === 'RUC' && numero.length === 11)) {
        btnConsultarSunat.disabled = false;
    } else {
        btnConsultarSunat.disabled = true;
    }

    // Limpiar badge y status si cambia el número
    apiBadge.style.display = 'none';
    sunatStatus.style.display = 'none';
});

// Consultar SUNAT
btnConsultarSunat.addEventListener('click', async function() {
    const tipo = documentTypeSelect.value;
    const numero = documentNumberInput.value.trim();

    if (!tipo || !numero) {
        alert('Selecciona el tipo de documento e ingresa el número');
        return;
    }

    // Validar longitud
    if (tipo === 'DNI' && numero.length !== 8) {
        alert('El DNI debe tener 8 dígitos');
        return;
    }

    if (tipo === 'RUC' && numero.length !== 11) {
        alert('El RUC debe tener 11 dígitos');
        return;
    }

    // Mostrar loading
    btnConsultarSunat.disabled = true;
    btnConsultarSunat.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Consultando...';
    sunatStatus.style.display = 'block';
    sunatStatus.innerHTML = '<div class="alert alert-info mb-0"><i class="bi bi-cloud-arrow-down"></i> Consultando en SUNAT/RENIEC...</div>';

    try {
        const response = await fetch(`/customers/api/consultar-documento?tipo=${tipo}&numero=${numero}`);
        const result = await response.json();

        if (result.success) {
            // Autocompletar datos
            nameInput.value = result.data.nombre || '';
            addressInput.value = result.data.direccion || '';

            // Mostrar éxito
            sunatStatus.innerHTML = `<div class="alert alert-success mb-0">
                <i class="bi bi-check-circle"></i> Datos encontrados en ${tipo === 'DNI' ? 'RENIEC' : 'SUNAT'}
                ${result.data.estado ? `<br><small>Estado: ${result.data.estado} | Condición: ${result.data.condicion}</small>` : ''}
            </div>`;

            // Actualizar badge según tipo de documento
            apiBadgeText.textContent = tipo === 'DNI' ? 'RENIEC' : 'SUNAT';
            apiBadge.style.display = 'inline-block';

            // Auto-focus en siguiente campo vacío
            if (!document.getElementById('email').value) {
                document.getElementById('email').focus();
            }
        } else {
            sunatStatus.innerHTML = `<div class="alert alert-warning mb-0">
                <i class="bi bi-exclamation-triangle"></i> ${result.message}
            </div>`;
        }
    } catch (error) {
        sunatStatus.innerHTML = `<div class="alert alert-danger mb-0">
            <i class="bi bi-x-circle"></i> Error al consultar: ${error.message}
        </div>`;
    } finally {
        // Restaurar botón
        btnConsultarSunat.disabled = false;
        btnConsultarSunat.innerHTML = '<i class="bi bi-search"></i> Buscar Documento';
    }
});

// Permitir consulta con Enter en el campo de documento
documentNumberInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !btnConsultarSunat.disabled) {
        e.preventDefault();
        btnConsultarSunat.click();
    }
});
</script>
{% endblock %}
